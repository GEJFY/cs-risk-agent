name: CD - Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'deploy' to confirm production deployment"
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Confirm deployment
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.confirm }}" != "deploy" ]; then
            echo "::error::Deployment not confirmed. Type 'deploy' to proceed."
            exit 1
          fi

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build production images
        run: |
          docker build -f infra/docker/Dockerfile.backend \
            -t cs-risk-agent-backend:${{ github.sha }} .
          docker build -f infra/docker/Dockerfile.frontend \
            -t cs-risk-agent-frontend:${{ github.sha }} .

      - name: Deploy (platform-specific)
        run: |
          echo "Production deployment for ${{ vars.DEPLOY_TARGET }}"
          echo "Image tag: ${{ github.sha }}"
          echo "Deployment would proceed here based on DEPLOY_TARGET"

      - name: Health check
        run: |
          echo "Running post-deployment health check..."
          # curl -f ${{ vars.PRODUCTION_URL }}/api/v1/health/ || exit 1

      - name: Notify
        if: always()
        run: echo "Production deployment status: ${{ job.status }}"
