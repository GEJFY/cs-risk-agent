name: CD - Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- Azure Login (条件付き) ---
      - name: Azure Login
        if: vars.DEPLOY_TARGET == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build & Push to ACR
        if: vars.DEPLOY_TARGET == 'azure'
        run: |
          az acr login --name ${{ vars.ACR_NAME }}
          docker build -f infra/docker/Dockerfile.backend -t ${{ vars.ACR_NAME }}.azurecr.io/cs-risk-agent-backend:staging .
          docker push ${{ vars.ACR_NAME }}.azurecr.io/cs-risk-agent-backend:staging

      - name: Deploy to Azure App Service
        if: vars.DEPLOY_TARGET == 'azure'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.AZURE_APP_NAME }}
          images: ${{ vars.ACR_NAME }}.azurecr.io/cs-risk-agent-backend:staging

      # --- AWS Deploy (条件付き) ---
      - name: Configure AWS Credentials
        if: vars.DEPLOY_TARGET == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy to ECS
        if: vars.DEPLOY_TARGET == 'aws'
        run: |
          aws ecs update-service \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --service ${{ vars.ECS_SERVICE }} \
            --force-new-deployment

      # --- GCP Deploy (条件付き) ---
      - name: Google Auth
        if: vars.DEPLOY_TARGET == 'gcp'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy to Cloud Run
        if: vars.DEPLOY_TARGET == 'gcp'
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ vars.CLOUD_RUN_SERVICE }}
          region: ${{ vars.GCP_REGION }}
          image: ${{ vars.GCP_IMAGE }}

      - name: Notify deployment
        if: always()
        run: echo "Staging deployment completed with status ${{ job.status }}"
